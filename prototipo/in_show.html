<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="description" content="dClapp">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>dClapp</title>
	<link rel="icon" type="image/jpg" href="images/favicon.png">
	<link rel="stylesheet" href="css/styles.css">
	<meta name="p:domain_verify" content="010c67b82d18bca303e35e8b40011654"/>

</head>

<body>
	<div class="container showtime">
        <span class="posicion"></span>
		<button class="boton end_show" onclick="end_show();">
			END
		</button>
		<div class="intro_clapp">
			<h3>
                The party started
            </h3>
		</div>
	</div>

	

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.1/firebase.js"></script>
    <script type="text/javascript" src="js/firebase-config.js"></script>
    <script type="text/javascript" src="js/script.js"></script>
	<script type="text/javascript">
		
		
		const firestore = firebase.firestore();
		const settings = {/* your settings... */ timestampsInSnapshots: true};
		firestore.settings(settings);

		//coge el ID de la usuario mandado por URL parameter desde la pantalla del login
		var URL_banda = getUrlParameter("band");
		var banda;
		var showId;

		//traer banda de base de datos
		const bandRef = firestore.collection("bandas").doc(URL_banda);
		bandRef.get().then((doc) => {
			banda = doc.data();
			console.log("banda: " + banda.nombre);
		})
		
		//guardar show en shows
		tryGeolocation();
		
		function showtime() {
			console.log("showtime2");
			
			const timestamp = firebase.firestore.FieldValue.serverTimestamp();
			const showRef = firestore.collection("shows");

			//guardar objeto del show
			var show = {};
			show.banda = URL_banda;
			show.posicion = {}
			show.posicion.latitud = latitud;
			show.posicion.longitud = longitud;
			show.comienzo = timestamp;
			show.active = true;

			//subir show a shows
			showRef.add(show)
				.then((show) => {
					//subir shows a banda
					showId = show.id;
					console.log(showId);
					showRef.doc(showId).update({showId: showId});
					bandRef.update({
						shows: firebase.firestore.FieldValue.arrayUnion(showId)
					});
				}).catch(function(error){
					console.log("error: " + error);
				}
			);
		}
		
		function end_show() {
			// showId = showId._key.path.segments[1];
			const showRef = firestore.collection("shows");
			const timestamp = firebase.firestore.FieldValue.serverTimestamp();
			showRef.doc(showId).update({
				active: false,
				final: timestamp
			}).then(function() {
				window.history.back();
			});
		};
		 
	</script>
	
 </body>
</html>








