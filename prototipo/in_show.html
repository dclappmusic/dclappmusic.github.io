<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="description" content="dClapp">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>dClapp</title>
	<link rel="icon" type="image/jpg" href="images/favicon.png">
	<link rel="stylesheet" href="css/styles.css">
	<meta name="p:domain_verify" content="010c67b82d18bca303e35e8b40011654"/>

</head>

<body>
	<div class="container showtime">
        <span class="posicion"></span>
		<button class="boton end_show" onclick="end_show();">
			END
		</button>
		<div class="intro_clapp">
			<h3>
                conectando
            </h3>
		</div>
	</div>

	

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.5.1/firebase.js"></script>
<script type="text/javascript" src="js/firebase-config.js"></script>
<script type="text/javascript" src="js/script.js"></script>
<script type="text/javascript" src="js/geolocation.js"></script>
<script type="text/javascript">
	//coge el ID de la usuario mandado por URL parameter desde la pantalla del login
	var bandId = getUrlParameter("band");
	var banda;
	var showId;

	//traer banda de base de datos
	const bandRef = firestore.collection("bandas").doc(bandId);
	bandRef.get().then((doc) => {
		banda = doc.data();
		console.log("banda: " + banda.nombre);
		//ver si hay algun show activo
		if (banda.show_active) {
			console.log("ya hay un show activo");
			console.log(banda.shows[banda.shows.length - 1]);
			showId = banda.shows[banda.shows.length - 1];
		} else {
			//guardar show en shows
			tryGeolocation();
		}
	})

	//if band.show_active es true, no crear show, entrar en el activo
	//else showtime 
	
	function showtime() {
		console.log("showtime2");
		
		const timestamp = firebase.firestore.FieldValue.serverTimestamp();
		const showRef = firestore.collection("shows");

		//guardar objeto del show
		var show = {};
		show.banda = bandId;
		show.posicion = {}
		show.posicion.latitud = latitud;
		show.posicion.longitud = longitud;
		show.comienzo = timestamp;
		show.active = true;
		show.num_clapps = 0;

		//subir show a shows
		showRef.add(show)
			.then((show) => {
				//subir shows a banda
				showId = show.id;
				console.log(showId);
				showRef.doc(showId).update({showId: showId});
				bandRef.update({
					shows: firebase.firestore.FieldValue.arrayUnion(showId),
					show_active: true
				});
				$(".intro_clapp h3").html("The party started");
			}).catch(function(error){
				console.log("error: " + error);
			}
		);
	}
	
	function end_show() {
		const showRef = firestore.collection("shows");
		const timestamp = firebase.firestore.FieldValue.serverTimestamp();

		bandRef.update({
			show_active: false
		});
		showRef.doc(showId).update({
			active: false,
			final: timestamp
		}).then(function() {
			window.history.back();
		});

		//acabar el show cuando pase x tiempo
	};

	function funcion_user () {};
		 
</script>
</body>
</html>








