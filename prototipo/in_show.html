<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="description" content="dClapp">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>dClapp</title>
	<link rel="icon" type="image/jpg" href="images/favicon.png">
	<link rel="stylesheet" href="css/styles.css">
	<meta name="p:domain_verify" content="010c67b82d18bca303e35e8b40011654"/>

</head>

<body>
	<div class="container showtime">
        <span class="posicion"></span>
		<button class="boton end_show" onclick="end_show();">
			END
		</button>
		<div class="intro_clapp">
			<h3>
                connecting
            </h3>
		</div>
	</div>

	

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.5.1/firebase.js"></script>
<script type="text/javascript" src="js/firebase-config.js"></script>
<script type="text/javascript" src="js/script.js"></script>
<script type="text/javascript" src="js/geolocation.js"></script>
<script type="text/javascript">
	//coge el ID de la usuario mandado por URL parameter desde la pantalla del login
	var bandId = getUrlParameter("band");
	var banda;
	var showId;
	var band_preclapps;

	const bandRef = firestore.collection("bandas").doc(bandId);
	const showRef = firestore.collection("shows");

	//traer banda de base de datos
	bandRef.get().then((doc) => {
		banda = doc.data();
		console.log("banda: " + banda.nombre);
		band_preclapps = banda.num_clapps;
		//ver si hay algun show activo
		if (banda.show_active) {
			console.log("ya hay un show activo");
			console.log(banda.shows[banda.shows.length - 1]);
			showId = banda.shows[banda.shows.length - 1];
			$(".intro_clapp h3").html("The party is on");
		} else {
			//guardar show en shows
			tryGeolocation();
		}
	})

	//if band.show_active es true, no crear show, entrar en el activo
	//else showtime 
	
	function showtime() {
		console.log("showtime2");
		
		const timestamp = firebase.firestore.FieldValue.serverTimestamp();

		//guardar objeto del show
		var show = {};
		show.banda = bandId;
		show.posicion = {}
		show.posicion.latitud = latitud;
		show.posicion.longitud = longitud;
		show.comienzo = timestamp;
		show.active = true;
		show.num_clapps = 0;

		//subir show a shows
		showRef.add(show)
			.then((doc) => {
				//subir shows a banda
				showId = doc.id;
				console.log(showId);
				showRef.doc(showId).update({showId: showId});
				bandRef.update({
					shows: firebase.firestore.FieldValue.arrayUnion(showId),
					show_active: true
				});
				//datos para el historial de shows
				bandRef.collection("shows").doc(showId).set({
					showId: showId,
					preclapps: band_preclapps,
					fecha: timestamp,
					totalclapps: 0
				});
				$(".intro_clapp h3").html("The party started");
			}).catch(function(error){
				console.log("error: " + error);
			}
		);
	}

//*acabar el show cuando pase x tiempo
	
	function end_show() {
		// debugger;
		const timestamp = firebase.firestore.FieldValue.serverTimestamp();
		var show_preclapps;
		var show_posclapps;
		
		//coger el numero de preclapps
		bandRef.collection("shows").doc(showId).get().then((doc) => {
			var snap = doc.data();
			show_preclapps = snap.preclapps;
			console.log("show preeclaps: " + show_preclapps);

			//coger el numero de clapps de la banda al acabar el concierto
			bandRef.onSnapshot((doc) => {
				var snap = doc.data();
				show_posclapps = snap.num_clapps;
			});
			console.log("posclapps: " + show_posclapps);
		});
		
		//el total el numero final de clapps de la banda, menos el que tenía al empezar.
		var showclapps = show_posclapps - show_preclapps;
		console.log("showclapps: " + showclapps);

		//poner que la banda ya no tiene ningun show activo
		bandRef.update({
			show_active: false
		}).then(function() {
			//agregar objeto del show a la banda
			bandRef.collection("shows").doc(showId).update({
				totalclapps: showclapps
			}).then(function() {
				//hora del final de concierto, y quitar que esté activo. REDIRECCIONAR ATRÁS
				showRef.doc(showId).update({
					active: false,
					final: timestamp
				}).then(function() {
					// debugger;
					window.history.back();
				});
			});
		});

		
	};

	function funcion_user () {};
		 
</script>
</body>
</html>








