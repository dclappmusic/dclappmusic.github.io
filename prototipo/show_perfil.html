<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="description" content="dClapp">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>dClapp</title>
	<link rel="icon" type="image/jpg" href="images/favicon.png">
	<link rel="stylesheet" href="css/styles.css">
	<meta name="p:domain_verify" content="010c67b82d18bca303e35e8b40011654"/>

</head>

<body>
	<div class="container show_perfil">
        <a class="hide cambio_modo" href="index.html">volver a clapp</a>
        
        <div class="act">
            <label class="imagen" for="band-image"></label>
            <input id="band-image" class="image-input" type="file" name="band-imagen" accept="image/png, image/jpeg" id="band-image" disabled>
            <!-- <div class="imagen"></div> -->
            <input id="band-name" class="titulo name" type="text" name="band-name" value="" disabled>
            <h2 class="titulo name"></h2>
            <ul class="tabs">
                <li class="menu-tit active" data-tab="stats">STATS</li>
                <li class="menu-tit" data-tab="info">INFO</li>
                <li class="menu-tit" data-tab="shows">SHOWS</li>
            </ul>
        </div>
        <div class="secciones">
            <div class="stats">
                <ul class="resumen">
                    <li class="ciudad">
                        <p>...</p>
                    </li>
                    <li class="clapps">
                        <p>...</p>
                    </li>
                    <li class="actuaciones">
                        <p>...</p>
                    </li>
                </ul>
            </div>
            <div class="info">
                <span class="editar">
                    <img class="edit" src="images/icon-edit.svg" />
                    <img class="save" src="images/icon-save.svg" />
                </span>
                <textarea id="band-descripcion" class="parrafo descripcion" type="text" name="band-descripcion" value="" disabled></textarea>
            </div>
            <div class="shows">
                shows
                <p class="boton-sm" onclick="deleteBand();">delete band</p>
            </div>
        </div>
        <ul class="hide menu">
            <li class="menu-tit">
                <a href="#">historial</a>
            </li>
            <li class="menu-tit" id="preclapp">
                <a href="showtime.html">SHOW</a>
            </li>
            <li class="menu-tit active">
                <a href="show_perfil.html">perfil</a>
            </li>
        </ul>
	</div>

	

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.5.1/firebase.js"></script>
<script type="text/javascript" src="js/firebase-config.js"></script>
<script type="text/javascript" src="js/script.js"></script>
<script type="text/javascript">
    //tabs
    $(".tabs li").click(function(){
        var tab = $(this).data("tab");
        console.log(tab);
        $(this).addClass("active").siblings().removeClass("active");
        $(".secciones ." + tab).show().siblings().hide();
    });

    //hacer editables los inputs
    $(".edit").click(function() {
        $(".show_perfil").css("background-color", "rgba(12, 56, 71, 0.2)");
        $(this).hide().siblings().show();
        $("input, textarea").prop('disabled', false).addClass("able");
        $(".editar").addClass("able");
        $(".imagen").addClass("able");
        $(".hide").hide();
    });
    $(".save").click(function() {
        $(".show_perfil").css("background-color", "#F1F1F1");
        $(this).hide().siblings().show();
        $("input, textarea").prop('disabled', true).removeClass("able");
        $(".imagen").removeClass("able");
        $(".editar").removeClass("able");
        $(".hide").show();
        actualizar_perfil();
    });

    //hide menu on input focus
    $("input, textarea").on('focus', function() {
        document.body.scrollTop = $(this).offset().top;
        $(".menu").hide()
    });
    $("input, textarea").on('blur', function() {
        document.body.scrollTop = 0;
        $(".menu").show();
    });


    function funcion_user () {
	    userRef = firestore.collection("usuarios").doc(userId);
    };    
    
    var bandId = getUrlParameter("band");

	//poner bandId en todos los links para seguir mostrando la misma banda
    $('a').each(function() {
        var href = $(this).attr('href');
        if (href && (href != "index.html")) {
            href += (href.match(/\?/) ? '&' : '?') + "band=" + bandId;
            $(this).attr('href', href);
        }
    });

//traer banda de base de datos
    var banda;
    const bandRef = firestore.collection("bandas").doc(bandId);
    var userRef;
    var tiene_foto = false;

    bandRef.onSnapshot((snap) => {
        banda = snap.data();
        console.log("banda: " + banda.nombre);

    //diplay en pantalla de datos de la banda
        $("#band-name").attr("value", banda.nombre);
        $(".resumen .ciudad p").html(banda.ciudad);
        $(".resumen .clapps p").html(banda.num_clapps);
        if (banda.shows) {
            $(".resumen .actuaciones p").html(banda.shows.length);
        } else {
            $(".resumen .actuaciones p").html("0");
        }
        if (banda.imagen) {
            tiene_foto = true;
            $(".act .imagen").css("background-image", "url(" + banda.imagen + ")");
        } else {
            $(".act .imagen").css("background-image", "url(images/perfil_kurt.png)");
        }
        if (banda.descripcion) {
            $("#band-descripcion").html(banda.descripcion);
        } else {
            console.log("no descripcion");
            $("#band-descripcion").html("Todavía no sabemos quién es " + banda.nombre);
            // console.log($("#band-descripcion").value());
        }
        // $(".act .descripcion .parrafo").html(band.descripcion);
    });
    
    //si cambian los datos, coger los nuevos y guardarlos en un array
    var cambios = {};
    $("#band-name").change(function() {
        cambios.nombre = document.querySelector("#band-name").value;
    });
    $("#band-image").change(function() {
        imageUp();
        // cambios.imagen = document.querySelector("#band-image").files[0];
    });
    $("#band-descripcion").change(function() {
        cambios.descripcion = document.querySelector("#band-descripcion").value;
    });
  

    //actualizar el perfil de la banda en la DB
    function actualizar_perfil() {
        bandRef.update(cambios);
//* actualizar el nombre de la banda en el objeto_usuario
    }

    //actualizar la imagen de perfil
    const storageRef = firebase.storage().ref();

    function imageUp() {
		var imagen = document.querySelector("#band-image").files[0];
		const fotoId = bandId;
		const upload = storageRef.child(fotoId).put(imagen);

		upload.on('state_changed', function(snapshot) {
			// Observe state change events such as progress, pause, and resume
			// Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
			var progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
			$(".imagen").html(progress + "%");
		}, function(error) {
			// Handle unsuccessful uploads
			console.log("error: " + error);
		}, function() {
			// Handle successful uploads on complete
			upload.snapshot.ref.getDownloadURL().then((url) => {
				cambios.imagen = url;
			});
		});
    };
    

    //borrar banda
    function deleteBand() {
        var confirmar = confirm("¿Seguro que quieres borrar tu banda? todos sus datos se perderán de manera permanente.");
        var newBand = [];
        if (confirmar == true) {
            debugger;
            userRef.get().then(doc => {
                user = doc.data();
                const user_bands = user.band;
                console.log(user_bands);
                newBand = user_bands.filter(band => band.band_id !== bandId);
                console.log(newBand);
                userRef.update({
                    band: newBand
                }).then(function() {
                    debugger;
                    console.log("borrada con exito de user");
                    bandRef.delete().then(function() {
                        console.log("borrada con exito de bandas");
                        if (tiene_foto) {
                            storageRef.child(bandId).delete().then(function() {
                                console.log("borrada con exito de imagenes");
                                debugger;
                                window.location.href = "index.html";
                            }).catch((error) => {
                                console.error("Error removing de bandas: ", error);
                            });
                        } else {
                            debugger;
                            window.location.href = "index.html";
                        }
                    }).catch((error) => {
                        console.error("Error removing de bandas: ", error);
                    });
                }).catch((error) => {
                    console.error("Error removing de user: ", error);
                });
            });
            
        } else {
            console.log("abortado");
        }
    };


</script>
</body>
</html>








