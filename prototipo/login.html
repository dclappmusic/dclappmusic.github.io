<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="description" content="dClapp">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>dClapp</title>
	<link rel="icon" type="image/jpg" href="images/favicon.png">
	<link rel="stylesheet" href="css/styles.css">
    <meta name="p:domain_verify" content="010c67b82d18bca303e35e8b40011654"/>
</head>

<body>
	<div class="container login">
        <a class="close" href="index.html">
            <svg xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M12.6953 14.0771L22.3037 24L24.3906 21.8447L14.7822 11.9224L23.4668 2.95361L21.3789 0.79834L12.6943 9.7666L3.81543 0.597168L1.72852 2.75244L10.6074 11.9219L0.804688 22.0459L2.8916 24.2012L12.6953 14.0771Z" fill="#0C3847"/>
            </svg>    
        </a>
        <h1 class="cabecera"><img src="images/icon_completo.png"></h1>
        <div class="tabs">
            <h3 class="login menu-tit active" data-href="login">LOG IN</h3>
            <h3 class="signup menu-tit" data-href="signup">SIGN UP</h3>
            <h3 class="reset menu-tit" data-href="reset">RESET</h3>
        </div>
        <div class="form">
            <div class="inputs_comunes">
                <label for="user-email" class="form-label">Email</label>
                <input class="form-input" id="user-email" placeholder="email" type="text" name="user-email" value="">
                <label for="user-password" class="form-label password">Contrase침a</label>
                <input class="form-input" id="user-password" placeholder="contrase침a" type="password" name="user-password" value="">
            </div>
            <div class="tab login active">
                <button id="boton" class="boton-med" onclick="login();">
                    login
                </button>
            </div>
            <div class="tab signup">
                    <label for="user-city" type="text" class="form-label">Ciudad</label>
                    <input class="form-input" id="user-city" placeholder="Madrid" type="text" name="user-city" value="" autocomplete="on">
                <button id="boton" class="boton-med" onclick="signUp();">
                    Sign UP
                </button>
            </div>
            <div class="tab reset">
                <button id="boton" class="boton-med" onclick="reset();">
                    Reset
                </button>
            </div>
        </div>
        <div class="logout">
            <span class="welcome"></span>
            <div class="boton-med logout_btn" onclick="logout();">
                logout
            </div>
        </div>
        <!-- <div class="social_login">
            <button class="fb_login" onclick="sign_up_fb();"></button>

        </div> -->
    </div>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.1/firebase.js"></script>
    <script type="text/javascript" src="js/firebase-config.js"></script>

    <script type="text/javascript">
    //Change tabs log-sign-forgot
        $(".tabs h3").click(function(){
            var tab = $(this).attr("data-href");
            $(this).addClass("active").siblings().removeClass("active");

            $(".form .tab." + tab).addClass("active").siblings().removeClass("active");

            if (tab === "reset") {
                $("#user-password").hide();
                $("label.password").hide();
            } else {
                $("#user-password").show();
                $("label.password").show();
            }
        });


    //autentication    
        const auth = firebase.auth();

        const user_email = document.getElementById("user-email");
        const user_password = document.getElementById("user-password");
        const user_city = document.getElementById("user-city");

        function login() {
            const email = user_email.value;
            const password = user_password.value;
            
            //autenticar el login
            auth.signInWithEmailAndPassword(email, password).then(function(){
                 //redirigir a index
                    var user = auth.currentUser;
                    window.location.href = "index.html";
            }).catch(function(error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
                window.alert("error: " + errorMessage) ;
            });
           
        }

        function logout() {
            auth.signOut().catch(function(error) {
                // An error happened.
                window.alert("error: " + error);
            });
        }

        function signUp() {
            const email = user_email.value;
            const password = user_password.value;
            const ciudad = user_city.value;
            
            //crear login de usuario
            auth.createUserWithEmailAndPassword(email, password)
                .then(function(){
                    //a침adir el usuario a la DB
                    const userRef = firestore.collection("usuarios");
                    var user = auth.currentUser;
                    
                    userRef.doc(user.uid).set({
                        uid: user.uid,
                        email: email,
                        ciudad: ciudad
                    }).then(function(){
                        window.location.href = "index.html";
                    });
                })
                .catch(function(error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
                window.alert("error: " + errorMessage) ;
            });
        }
        function reset() {
            const email = user_email.value;
            auth.sendPasswordResetEmail(email).then(function() {
            // Email sent.
            }).catch(function(error) {
            // An error happened.
            });
        }

        function sign_up_fb() {
            var provider = new firebase.auth.FacebookAuthProvider();
            provider.addScope('email');
            provider.addScope('user_age_range');
            provider.addScope('user_location');
            firebase.auth().useDeviceLanguage();
            firebase.auth().signInWithPopup(provider).then(function(result) {
                // This gives you a Facebook Access Token. You can use it to access the Facebook API.
                var token = result.credential.accessToken;
                // The signed-in user info.
                var user = result.user;
                // ...
                }).catch(function(error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
                // The email of the user's account used.
                var email = error.email;
                // The firebase.auth.AuthCredential type that was used.
                var credential = error.credential;
                // ...
            });
            
        }
        

        //Chekear si hay user logeado
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in.
                console.log("ya estas signeado");
                console.log(user);
                var user = auth.currentUser;
                var name, email, password;
                console.log(user);
                
                if(user != null) {
                    email = user.email;
                    $(".tabs").hide();
                    $(".form").hide();
                    $(".logout").show();
                    $(".welcome").html("bienvenido: " + email);
                    var href = $(".close").attr("href");
                    href += "?user=" + user.uid;
				    $(".close").attr('href', href);
                }
            } else {
                // No user is signed in.
                $(".tabs").show();
                $(".form").show();
                $(".logout").hide();
                $(".welcome").html("");
                console.log("no est치s signeado");
            }
        });






        //subir persona a la live database
        // var userRef = firebase.database().ref("usuarios");

        // function signUp() {
        //     var email = document.getElementById("email").value;
        //     var password = document.getElementById("password").value;

        //     var newUserRef = userRef.push();
        //     newUserRef.set({
        //         email: email,
        //         password: password
        //     });
        // }

        
	</script>
 </body>
</html>








